rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- DEBUGGING HELPER ---
    // This function gives the specified email god-mode access to help identify
    // which rule is failing for normal users.
    function isAdmin() {
      // The user's primary admin email address.
      return request.auth.token.email == 'jangrayash1505@gmail.com';
    }
    
    // --- Standard Helpers ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Function to check if a user is a member of a group by reading the group document.
    // Use this for single document reads/writes where you have the groupId.
    function isMemberOfGroup(groupId) {
        return isSignedIn() && get(/databases/$(database)/documents/groups/$(groupId)).data.memberIds.hasAny([request.auth.uid]);
    }

    // Function to check if a user is a member of a group by checking a field on the resource being accessed.
    // Use this for list queries on collections like expenses, settlements, history.
    function isMemberViaResource(resource) {
        return isSignedIn() && resource.data.groupMemberIds.hasAny([request.auth.uid]);
    }

    // --- Collection Rules ---

    // USERS
    match /users/{userId} {
      // Allow reading user profiles if signed in. This is needed to populate user info across the app.
      allow get, list: if isAdmin() || isSignedIn();
      // Allow creating a user document during signup.
      allow create: if isAdmin() || isSignedIn();
      // Allow updating your own user profile, but not changing your role.
      allow update: if isAdmin() || (isOwner(userId) && !('role' in request.resource.data));
      // Only admins can delete users.
      allow delete: if isAdmin();
    }
    
    // SETTINGS
    match /settings/general {
      // This MUST be public for the app layout to read the app name on the server.
      allow get: if true;
      // Only admins can change site settings.
      allow create, update, delete: if isAdmin();
    }

    // GROUPS
    match /groups/{groupId} {
      // Allow reading a group if you are a member.
      allow get: if isAdmin() || isMemberOfGroup(groupId);
      // Allow listing groups if you are signed in (the query itself is filtered by user ID).
      allow list: if isAdmin() || isSignedIn();
      // Allow creating groups if you are signed in.
      allow create: if isAdmin() || isSignedIn();
      // Allow members to update a group (e.g., adding members).
      allow update: if isAdmin() || isMemberOfGroup(groupId);
      allow delete: if isAdmin();
    }
    
    // EXPENSES
    match /expenses/{expenseId} {
      // Allow reads if you are a member of the group this expense belongs to.
      allow get: if isAdmin() || isMemberViaResource(resource);
      // Allow listing expenses if signed in (the query is filtered).
      allow list: if isAdmin() || isSignedIn();
      // Allow writes if you are a member of the group.
      allow create, update, delete: if isAdmin() || isMemberOfGroup(request.resource.data.groupId);
    }
    
    // SETTLEMENTS
    match /settlements/{settlementId} {
      allow get: if isAdmin() || isMemberViaResource(resource);
      allow list: if isAdmin() || isSignedIn();
      allow create: if isAdmin() || isMemberOfGroup(request.resource.data.groupId);
      // Only admins can modify settlements for audit integrity.
      allow update, delete: if isAdmin();
    }

    // HISTORY
    match /history/{historyId} {
      allow get: if isAdmin() || isMemberViaResource(resource);
      allow list: if isAdmin() || isSignedIn();
      // History is created by server logic when actions occur.
      allow create, update: if isAdmin() || isMemberOfGroup(request.resource.data.groupId);
      // Only admins can delete history.
      allow delete: if isAdmin();
    }
  }
}
